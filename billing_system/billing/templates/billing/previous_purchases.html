<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Previous Purchases</title>
  <style>
    body{font-family: Arial; margin:20px}
    table{border-collapse:collapse; margin-top:10px}
    td,th{border:1px solid #ccc; padding:6px}
    a{color:blue; text-decoration:none}
  </style>
</head>
<body>
  <h2>Previous Purchases</h2>
  <form method="get">
    <label>Customer Email:
      <input type="email" name="email" value="{{ email_query|default:'' }}">
    </label>
    <button type="submit">Search</button>
  </form>

  {% if invoices %}
    <h3>Invoices for {{ email_query }}</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Date</th><th>Total</th><th>Action</th></tr>
      </thead>
      <tbody>
      {% for inv in invoices %}
        <tr>
          <td>{{ inv.id }}</td>
          <td>{{ inv.created_at }}</td>
          <td>{{ inv.total_amount }}</td>
          <td><a href="?email={{ email_query }}&invoice_id={{ inv.id }}">View Items</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if selected_invoice %}
    <h3>Invoice #{{ selected_invoice.id }} Items</h3>
    <table>
      <thead>
        <tr><th>Product</th><th>Qty</th><th>Price</th><th>Tax</th><th>Subtotal</th></tr>
      </thead>
      <tbody>
      {% for item in selected_invoice.items.all %}
        <tr>
          <td>{{ item.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.price }}</td>
          <td>{{ item.tax_amount }}</td>
          <td>{{ item.subtotal }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
</body>
</html>
