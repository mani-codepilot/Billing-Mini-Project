<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Billing - Create Invoice</title>
  {% load static %}
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #333;
    }
    header {
      background: #2b7cff;
      color: #fff;
      padding: 15px 20px;
    }
    header h2 {
      margin: 0;
      font-size: 20px;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 20px 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    h3 {
      margin-top: 0;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 5px;
      color: #444;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      padding: 8px;
      font-size: 14px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .product-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .product-row input {
      flex: 1;
    }
    .mini {
      width: 80px;
    }
    .btn {
      padding: 8px 14px;
      background: #2b7cff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.gray { background: #777; }
    .btn.secondary { background: #28a745; }
    .btn.remove {
      background: #dc3545;
    }
    .card {
      background: #fafafa;
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    #result {
      margin-top: 20px;
      background: #f8fff5;
      padding: 15px;
      border: 1px solid #c6e6c3;
      border-radius: 4px;
    }
    pre {
      background: #f0f0f0;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header>
    <h2>Create Bill</h2>
    <small>Logged in as: {{ request.user.username }} â€” <a href="/admin/" style="color:#fff;text-decoration:underline;">Admin</a></small>
  </header>

  <main>
    {% csrf_token %}
    <script>
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <div class="card">
      <div class="form-group flex-row">
        <div style="flex:1">
          <label>Customer Email</label>
          <input type="email" id="customer_email" placeholder="customer@example.com" required>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn secondary" id="view_history" style="white-space:nowrap;">View History</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Products</h3>
      <div id="products_container"></div>
      <button class="btn" id="add_product" type="button">+ Add Product</button>
    </div>

    <div class="card">
      <h3>Shop Denominations</h3>
      <div id="denominations_container">Loading denominations...</div>
    </div>

    <div class="card">
      <div class="form-group">
        <label>Paid Amount</label>
        <input type="number" step="0.01" id="paid_amount" placeholder="0.00">
      </div>
      <div class="form-group flex-row">
        <button class="btn" id="generate" type="button">Generate Bill</button>
        <button class="btn gray" id="reset" type="button">Reset</button>
      </div>
    </div>

    <div id="result"></div>
  </main>

<script>
function makeProductRow(pid='', qty=1){
  const div = document.createElement('div');
  div.className = 'product-row';
  div.innerHTML = `
    <input placeholder="Product ID" class="pid" value="${pid}">
    <input type="number" min="1" value="${qty}" class="qty mini">
    <button class="btn remove" type="button">Remove</button>
  `;
  div.querySelector('.remove').addEventListener('click', ()=>div.remove());
  return div;
}

document.getElementById('add_product').addEventListener('click', ()=>{
  document.getElementById('products_container').appendChild(makeProductRow());
});

document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('customer_email').value='';
  document.getElementById('products_container').innerHTML='';
  document.getElementById('result').innerHTML='';
  loadDenoms();
});

document.getElementById('view_history').addEventListener('click', ()=>{
  const email = document.getElementById('customer_email').value.trim();
  if(email){
    window.location.href = `/previous-purchases/?email=${encodeURIComponent(email)}`;
  } else {
    alert('Please enter a customer email first.');
  }
});

async function loadDenoms(){
  const cont = document.getElementById('denominations_container');
  cont.innerHTML = 'Loading...';
  const res = await fetch('/api/denominations/', {credentials: 'same-origin'});
  if(!res.ok){ cont.innerHTML = 'Please ensure you are logged-in and denominations exist.'; return; }
  const denoms = await res.json();
  cont.innerHTML = '';
  denoms.forEach(d => {
    const el = document.createElement('div');
    el.className = 'form-group flex-row';
    el.innerHTML = `
      <label style="flex:1">${d.value}</label>
      <input type="number" class="denom_count mini" data-value="${d.value}" value="${d.count_available}" min="0">
    `;
    cont.appendChild(el);
  });
}

document.getElementById('generate').addEventListener('click', async ()=>{
  const customer_email = document.getElementById('customer_email').value.trim();
  const paid_amount = document.getElementById('paid_amount').value || "0";
  const rows = Array.from(document.querySelectorAll('.product-row'));
  const items = rows.map(r => ({
    product_id: r.querySelector('.pid').value.trim(),
    quantity: r.querySelector('.qty').value
  }));

  const payload = { customer_email, items, paid_amount };

  const res = await fetch('/api/create-invoice/', {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-CSRFToken': csrftoken
    },
    credentials: 'same-origin',
    body: JSON.stringify(payload)
  });

  const out = document.getElementById('result');
  if(res.status === 201){
    const data = await res.json();
    out.innerHTML = `<h3>Invoice Created: #${data.id}</h3>
      <p><strong>Total:</strong> ${data.total_amount} | <strong>Paid:</strong> ${data.paid_amount} | <strong>Change:</strong> ${data.change_amount}</p>
      <pre>${JSON.stringify(data.denominations_given, null, 2)}</pre>
      <p><a href="/invoice/${data.id}/" class="btn">View Printable Invoice</a></p>
    `;
  } else {
    const err = await res.json();
    out.innerHTML = `<div style="color:red">${JSON.stringify(err)}</div>`;
  }
});

window.addEventListener('load', ()=> {
  document.getElementById('products_container').appendChild(makeProductRow());
  loadDenoms();
});
</script>
</body>
</html>
